<script src="/access/js/jquery.datetime-0.9.min.js"></script>
<script src="/access/js/jquery.tablesorter.min.js"></script>
<script src="/access/js/jquery.waypoints.min.js"></script>
<script type="text/javascript">
    $(document).ready(function(){
        window.init_times = function() {
            $('td.updated-at:not(.time-inited)').each(function(){
                $(this)
                    .attr('title', new Date($(this).attr('title')).toLocaleString())
                    .children('time')
                    .attr('title', $(this).attr('title'))
                    .addClass(".time-inited");
            }).children("time").datetime();
        };
        window.update_times = function() {
            $(" td.updated-at time").datetime(); 
        };
        window.init_times();
        window.setInterval(window.update_times, 500);
        window.sort_table = function() {
            var defaultHeadIndex = 2;
            var defaultHeadOrder = 0;
            var $activeHead = 'table thead tr th.headerSortDown, table thead tr th.headerSortUp';
            if($($activeHead).length !== 0) {
                defaultHeadIndex = $($activeHead).index();
                defaultHeadOrder = $($activeHead).hasClass('headerSortDown') ? 0 : 1;
            }
            // remove any previous click handler 
            // bound to table's headers if we don't
            // this the next `tablesorter()` will invoke
            // both of handler(i.e the previous handlers 
            // and the following new one) and thing will
            // get messy!!
            $('table.table .header').unbind('click');
            // make/re-make the table sortable
            $('table.table').tablesorter({
                sortList: [[defaultHeadIndex, defaultHeadOrder]],
                textExtraction: function(node) {
                    var txt = $(node).text();
                    if($(node).hasClass('updated-at')) {
                        txt = new Date($(node).attr('origin-date')).getTime();
                    }
                    if($(node).hasClass('status')) {
                        txt = $(node).attr('status') + $(node).next("td").text().trim();
                    }
                    return txt;
                },
                headers:{
                    0: { sorter: false }
                }
            });
        };
        // to make `$("input[type='checkbox'].item-checkbox").change()` auto-invokable!!
        $.propHooks.checked = {
            set: function(elem, value, name) {
              var ret = (elem[ name ] = value);
              $(elem).trigger("change");
              return ret;
            }
        };
        $("input[type='checkbox'].item-checkbox").change(function() {
            if($(this).prop('checked')) {
                $(this).parent().parent().css({"background-color": "#f7fafc"});
                $(this).parent().siblings('.item-name').addClass("item-checked-name");
                $(this).parent().parent().addClass("item-checked");
            } else {
                $(this).parent().parent().css("background-color", "transparent");
                $(this).parent().siblings('.item-name').removeClass("item-checked-name");
                $(this).parent().parent().removeClass("item-checked");
            }
        });
        $("button[name='ops']").click(function(e){
            if($(this).attr('value') === 'edit') return;
            e.preventDefault();
            var ops = String($(this).attr('value')).toLowerCase();
            var $this = this;
            switch(ops) {
                case "share":
                    ops = "toggle-share";
                case "remove":
                    var msg = "<u>#"+($("tr.item-checked").length)+"</u> <?php echo $active_type ?>s";
                    if($("tr.item-checked").length === 1) {
                        msg = "<u style='cursor:pointer'>"+$(".item-checked-name a").html()+"</u>";
                    }
                    window.top
                            .open_yesnoModal(
                            "Are your sure to <b>"+ops+"</b> "+msg+"?", 
                            function() {
                                window.submit_ops($this);
                            }
                        );
                    break;
                default:
                    window.submit_ops($this);
            }
        });
        $("button[value='edit']").click(function(e) {
            e.preventDefault();
            if($("input[type='checkbox'].item-checkbox:checked").first() === 0) return;
            $.ajax({
                type: "GET",
                url: "/ops/edit?<?php echo $active_type ?>="+$("input[type='checkbox'].item-checkbox:checked").first().val()+"&suppress_layout=1&continue=<?php echo $this->request->GetURI(); ?>"
            });
        });
        window.submit_ops = function($this) {
            $('form#opt-form').prepend($("<input>").attr("type", "hidden").attr("name", "ops").val($($this).attr('value')));
            var ops = $($this).attr('value');
            $.ajax({
                type: $('form#opt-form').attr('method'),
                url: $('form#opt-form').attr('action'),
                data: $('form#opt-form').serialize()+"&ajax=1",
                success: function(data) {
                    // unbind the success method to ignore the general result output
                    $(window).unbind('ajaxSuccess');
                    window.top.open_infoModal(data, 2700);
                    switch(String(ops).toLowerCase()) {
                        case "share":
                            window.location = '<?php echo $this->request->getURI(); ?>';
                            return;
                        case "remove":
                        case "restore":
                        case "trash":
                        case "archive":
                            window.apply_change(window.APPLY_REMOVE);
                            break;
                        default:
                            throw "Undefined operation `"+ops+"`!";
                    }
                    // set a timeout(50ms) for re-binding the ajax success method
                    setTimeout(function() { $(window).ajaxSuccess(window.ajax_success); }, 50);
                },
                error: function( jqXHR, textStatus, errorThrown) {
                    window.top.open_errorModal(jqXHR.responseText);
                }
            }).always(function(){
                // remove the simulated form submit btn
                $('form#opt-form input[name="ops"]').remove();
            });
        };
        window.fetch_more = function() {
            $(".ajax-loader-img-inf-scroll").removeClass("hidden");
            var sort_base = "";
            var $activeHead = 'table thead tr th.headerSortDown, table thead tr th.headerSortUp';
            var order = $($activeHead).hasClass('headerSortDown') ? 0 : 1;
            switch($($activeHead).index()) {
                default:
                case 2:
                    sort_base = 1;
                    break;
                case 3:
                    sort_base = 2;
                    break;
            };
            if(typeof(window.$o) === "undefined")
                window.$o = 30;
            console.log( "o="+$o+"&sort="+sort_base+"&order="+order+"&fetch=1<?php echo \zinux\kernel\security\security::GetHashString(array(session_id())) ?>");
            $.ajax({
                type: "GET",
                global:false,
                url: "<?php echo $this->request->getURI() ?>",
                data: "o="+$o+"&sort="+sort_base+"&order="+order+"&fetch=1<?php echo \zinux\kernel\security\security::GetHashString(array(session_id())) ?>",
                success: function(data) {
                    window.$o += <?php echo FETCH_LIMIT; ?>
                    // unbind the success method to ignore the general result output
                    $(window).unbind('ajaxSuccess');
                    // append data
                    $("#explorer-table table.table").append(data);
                    // init dates
                    window.init_times();
                    // update dates
                    $(" td.updated-at time").datetime();
                    // re-sort table
                    window.sort_table();
                    // bind a new scroll-more event handler
                    $("tr.item-row.fetch-more:last").waypoint(window.scroll_more);
                    // set a timeout(50ms) for re-binding the ajax success method
                    setTimeout(function() { $(window).ajaxSuccess(window.ajax_success); }, 50);
                },
                error: function(xhr) {
                    window.top.open_errorModal(xhr.responseText);
                }
            }).always(function(){
                $(".ajax-loader-img-inf-scroll").addClass("hidden");
            });
        };
        window.scroll_more = function() {
                // remove the fetch-more class from current element
                $(this).removeClass("fetch-more");
                // disable any future scoll callbacks from curremt element
                $(this).waypoint('disable');
                // fetch more item
                window.fetch_more();
            };
            $("tr.item-row.fetch-more:last").waypoint(window.scroll_more);
            window.sort_table();
    });
</script>