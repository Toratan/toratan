<?php if(!isset($this->posts)) throw new zinux\kernel\exceptions\invalidArgumentException("No `\$posts` arg. supplied"); ?>
<?php $is_profile_owner = @$this->is_owner;  ?>
<?php $is_preview_mode = @$this->preview_mode;  ?>
<div class="container col-lg-9  col-md-9  col-sm-8 col-xm-12 posts">
<?php if(count($this->posts)): ?>
    <?php if(!isset($this->request->params["infscroll"])): ?>
        <style type='text/css'>.blog-preview{position:relative;padding-left:120px;margin:60px 0}.blog-preview:first-child{margin-top:0}.blog-preview .blog-preview-excerpt{margin:1em 0;text-align:justify}.blog-preview .blog-preview-meta{position:absolute;top:0;left:0;width:100px;text-align:right;color:#a2aab1}.blog-preview .blog-preview-meta .day{font-size:140%;display:block}.blog-preview .blog-preview-meta .year{font-size:110%;color:#ccd0d4;display:block;margin-top:-8px}@media screen and (max-width:767px){.blog-preview{padding-left:0;margin:50px 0}.blog-preview .blog-preview-meta{position:static;text-align:left}.blog-preview .blog-preview-meta .day,.blog-preview .blog-preview-meta .year{color:#a2aab1;font-size:100%;margin:0;display:inline}.blog-preview .blog-preview-meta .day:after{content:', '}} .blog-preview .blog-preview-excerpt .view-article{text-transform: uppercase;padding:10px;font-weight: bold;}.blog-preview .blog-preview-title, .blog-preview .blog-preview-excerpt .blog-preview-context{word-break: break-all}.unbalanced-note {padding:10px; border: 1px solid #DDD;text-align: center;font-weight: bold}</style>
    <?php endif; ?>
    <?php foreach($this->posts as $post): $udate = strtotime($post->updated_at);// \zinux\kernel\utilities\debug::_var($post);?>
        <div class="row article">
            <article class="blog-preview">
                <h3 class="text-justify blog-preview-title" ><?php echo $post->note_title ?></h3>
                <div class="blog-preview-meta">
                    <span class="day"><?php echo date("M d", $udate) ?></span>
                    <span class="year"><?php echo date("Y", $udate) ?></span>
                </div>
                <div class="blog-preview-excerpt" style='padding-right: 10px;padding-left: 10px'>
                    <div class='blog-preview-context'>
                        <?php 
                            echo $post->note_summary;
                            
//                            $bs = "{$post->note_body}";
//                            $doc = new DOMDocument();
//                            # [```] for any possible code breaks
//                            @$doc->loadHTML(\preg_replace("#<p[^>]*>(\s|&nbsp;|\n|`)*</p>#i", "", \modules\opsModule\models\noteViewModel::__renderText("$bs\n\n```", 0)));     
//                            $xpath = new DOMXPath($doc);
//                            $body = $xpath->query('/html/body/p');
//                            $index = 0;
//                            $purified_note = "";
//                            while($index < $body->length) {
//                                $purified_note = @($doc->saveXml($body->item($index++)));
//                                if($purified_note !== "<p/>")
//                                    break;
//                                else $purified_note = "";
//                            }
//                            if(!strlen($purified_note))
//                                $purified_note = "<p class='unbalanced-note'><span class='glyphicon glyphicon-warning-sign'></span> No summary pattern detected.</p>";
//                            echo $purified_note;
                        ?>
                    </div>
                    <p>
                        <a class="btn btn-sm btn-primary view-article" href="/view/note/<?php echo $post->note_id ?>">View article</a>
                    </p>
                    <div class='clearfix'></div>
                </div>
        </article>
        </div>
    <?php endforeach; ?>
<?php else: ?>
    <div class="row article">
        <style>
            .error-header { border: 1px solid #cccccc; padding: 10px; font-weight: bold}
        </style>
        <article style="margin-bottom: 10px;margin-top: 10px;">
            <div class="error-404 text-center">
                <div class="error-header">
                    <span class="glyphicon glyphicon-warning-sign"></span> There are no more public article. 
                </div>
            </div>
        </article>
    </div>
<?php endif; ?>
    <div class='form-actions next-prev-link article' style='border-top:1px solid #DDD;padding-top:40px;padding-bottom: 40px;'>
<?php if($this->request->params["page"] > 1): ?>
        <a class='btn btn-link pull-left prev-page' rel="previous" href="/profile/<?php echo $is_preview_mode ? "preview/" : "" ?>posts/<?php echo $is_profile_owner ? "" : $this->profile->user_id."/0/" /* The `0` is for don't get params like {USER_ID => PAGE} in server side */?>page/<?php echo count($this->posts) ? $this->request->params["page"] - 1:  ceil($this->total_count / $this->fetch_limit) ?>"><span class='glyphicon glyphicon-arrow-left'></span> Previous Page</a>
<?php endif; ?>
<?php if($this->is_more_note): ?>
        <a class='btn btn-link pull-right next-page' rel="next" href="/profile/<?php echo $is_preview_mode ? "preview/" : "" ?>posts/<?php echo $is_profile_owner ? "" : $this->profile->user_id."/0/" /* The `0` is for don't get params like {USER_ID => PAGE} in server side */?>page/<?php echo $this->request->params["page"] + 1 ?>">Next Page <span class='glyphicon glyphicon-arrow-right'></span></a>
<?php endif; ?>
        <div class='clearfix'></div>
    </div>
</div>
<?php if(!isset($this->request->params["infscroll"])): ?>
    <link rel="stylesheet" href='/access/google-code-prettify/tomorrow-night.theme.min.css' />
    <script type="text/javascript" src="/access/google-code-prettify/prettify.js"></script>
    <script type='text/javascript'>
        (function(){
            prettyPrint();
        })();
    </script>
    <?php if($this->is_more_note): ?>
        <script type="text/javascript" src="/access/js/jscroll/jquery.jscroll.min.js"></script>
        <script type="text/javascript">
            (function(){
                var jscroll_callback = function() {
                    $('.next-prev-link').hide();
                    if($('.error-404').length !== 0)
                        // destroy jscroll, the procedure fecthed from internal `_destroy()` function in `jquery.jscroll.js` file
                        $('.posts')
                            .unbind('.jscroll')
                            .removeData('jscroll')
                            .find('.jscroll-inner').children().unwrap()
                            .filter('.jscroll-added').children().unwrap();
                };
                jscroll_callback();
                $('.posts').jscroll({
                    loadingHtml: '<center><img src="/access/img/ajax-loader.gif" alt="Loading" /></center>',
                    nextSelector: 'a.next-page:last',
                    contentSelector: '.article',
                    callback: jscroll_callback
                });
            })(jQuery);
        </script>
    <?php endif; ?>
<?php endif; ?>