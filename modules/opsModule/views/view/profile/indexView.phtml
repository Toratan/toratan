<?php 
    list($avatar_uri , $def_avatar) = \core\ui\html\avatar::get_avatar_link($this->profile->user_id);
   $is_profile_owner = (@\core\db\models\user::GetInstance()->user_id == $this->profile->user_id); 
    $p = $this->profile->to_array();
    $p["full_name"] = $this->user->get_RealName_or_Username();
    unset($p["settings"]); 
    $pj = json_encode($p);
    /**
     * Validates if we should render a section of array as profile info
     */
    $should_render = function(array $p, $section) {
        if(!is_string($section)) throw new \zinux\kernel\exceptions\invalidArgumentException("The arg `section` is not string");
        if(!strlen($section)) throw new \zinux\kernel\exceptions\invalidArgumentException("The arg `section` cannot be empty");
        if(!array_key_exists($section, $p)) throw new \zinux\kernel\exceptions\invalidArgumentException("The arg `$section` does not exists in array `p`");
        switch($section) {
            case "birth_day":
            case "birth_month":
            case "birth_year":
                return $p[$section] != 0;
            case "is_male":
                return $p[$section] != -1;
            default: 
                if(is_string($p[$section]))
                    return strlen($p[$section]);
                if(is_array($p[$section]))
                    return count($p[$section]);
                throw new \zinux\kernel\exceptions\invalidOperationException("The arg `\$p[\$section]` is not neighed `string` nor `array`!!!");
        }
    };
    $inf = array();
    foreach($p as $key => $value) {
        $l = "$key";
        $v = "";
        $s = "basic";
        $convert_labels = array(
                "is_male" => "gender",
                "intro" => "introduction",
                "occu" => "occupation",
                "edu" => "education",
                
        );
        $convert_section = array(
           "phone" => "contact",
           "site" => "contact",
           "public_email" => "contact",
            "intro" => "bio",
            "occu" => "bio",
            "edu" => "bio",
        );
        if(in_array($key, array("user_id", "last_name", "first_name", "full_name", "created_at", "updated_at")))
                continue;
        if(key_exists($key, $convert_labels))
                $l = $convert_labels[$key];
        if(key_exists($key, $convert_section))
                $s = $convert_section[$key];
        switch($key) {
            case "birth_day":
            case "birth_month":
                $l = "Birth Date";
                 if($should_render($p, "birth_month"))
                     $v = date('F ', mktime(0, 0, 0, $p["birth_month"]));
                 if($should_render($p, "birth_day"))
                     $v .= $p["birth_day"];
                 $key = "birth_date";
                 break;
            case "country":
            case "city":
                $l = "Location";
                if($should_render($p, "country"))
                    $v = $p["country"];
                if($should_render($p, "city"))
                    $v .= (($should_render($p, "country") ? ", ": " ") . $p["city"]);
                $key = "location";
                break;
            default:
__DEFAULT_OPS:
                 $l =ucwords(str_replace("_", " ", $l));
                 if($should_render($p, $key))
                         $v = $value;
        }
        if(!strlen($v) && $is_profile_owner) {
            $eu = "/profile/edit/step/";
            $step = 1;
            switch($key) {
            }
            $eu .= $step;
            $v = 'Not specified <span class="small"><a href="'.$eu.'">(Edit)</a></span>';
        }
        if(strlen($v)) {
            $k = "";
            // the UI span row#
            $span = 1;
            switch($s) {
                case "basic": $k = "Basic Information"; break;
                case "bio": $k = "Bio."; $span = 2;break;
                case "contact": $k = "Contact Information"; break;
                default: throw new zinux\kernel\exceptions\invalidArgumentException("Undefined `section` value: $s");
            } 
            $inf[$s]["label"] = $k;
            $inf[$s]["span"] = $span;
            $inf[$s]["values"][$key]["label"] = $l;
            $inf[$s]["values"][$key]["value"] = $v;
        }
    }
    \zinux\kernel\utilities\debug::_var($inf);
?>
<script type="text/javascript">
    $(document).ready(function() {
        var p = JSON.parse('<?php echo $pj ?>');
        console.log(p);
    });
</script>
<div class='row' style=''>
    <div class="pull-left col-md-3 col-sm-4 col-xs-4 avatar">
        <div class="row" style="margin:10px;width: 100%">
            <div class=" text-center" style="background-color: transparent;width: 100%">
                <div class='mosaic-block bottom-bar'>
                <?php if($is_profile_owner) : ?>
                    <a href="/profile/avatar"  class="mosaic-overlay" style="display: inline; left: 0px; bottom: -45px;">
                        <div class="details text-center ">
                            <h1><span class="glyphicon glyphicon-picture"></span><br /><b>Change</b></h1>
                        </div>
                    </a>
                <?php endif ; ?>
                    <a href="/profile/avatar/view/<?php echo $this->profile->user_id, "?", \zinux\kernel\security\security::GetHashString(array($this->profile->user_id)) ?>" target="__blank">
                        <img id="thumbnail" class='image img-thumbnail img-responsive 'src="<?php echo $avatar_uri ?>" onerror="this.src='<?php echo $def_avatar ?>';"  />
                    </a>
                </div>
                <div class='clearfix'></div>
                <div  class='' style='margin-top: 10px; overflow: hidden;word-break: break-all'>
                    <div class='text'>
                    <strong><?php echo $p["full_name"] ?></strong>
                    </div>
                    <div class='text-muted block small' style='margin-top:10px;'>
                        <span class='glyphicon glyphicon-flag'></span> Joined at <?php echo date("M Y", strtotime($p["created_at"])); ?>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style type='text/css'>
        .mosaic-block { float: none; display: -moz-inline-stack; display:inline-block; vertical-align:top; *display:inline; background-color:transparent; }
        #about .row .about-block{ min-height: 200px}
        #about .row .about-block table{ margin:10px; width: 100%}
        #about .row .about-block .table tr th, 
        #about .row .about-block .table tr td{ border: 0!important; padding: 0;}
        #about .row .about-block .table tr td{  padding-bottom: 4px }
        #about .row .about-block .table tr td:first-child{ color: #89919C; }
        @media screen and (min-width: 0px) and (max-width: 500px) {
            .clearfix.hidden {display: block!important}
            .avatar {width:100%!important}
            .col-md-6{width: 110%!important}
        }
        @media screen and (min-width: 520px) and (max-width: 990px) {
            .col-md-6{width: 100%!important}
        }
    </style>
<script type='text/javascript'>
    $(document).ready(function() {
        var info = JSON.parse('<?php echo addslashes(json_encode($inf)); ?>');
        console.log(info);
    });
</script>
    <div class='clearfix hidden'></div>
    <div class="pull-left col-md-9 col-sm-8 col-xm-8">
        <div id="about" class=''>
            <div class='row' style=''>
                <div class='col-md-6 col-sm-12 col-xs-12 about-block' style=''>
                    <legend>Basic Information</legend>
                    <table class='table' style='width: 100%'>
                        <thead>
                            <tr>
                                <th class='col-md-4'></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
<?php if($should_render($p, "birth_month")): ?>
                            <tr>
                                <td>Birth Date</td>
                                <td><?php 
                                    if($should_render($p, "birth_month"))
                                        echo date('F ', mktime(0, 0, 0, $p["birth_month"]));
                                    if($should_render($p, "birth_day"))
                                        echo $p["birth_day"];
                                ?></td>
                            </tr>
<?php endif; ?>
<?php if($should_render($p, "birth_year")): ?>
                            <tr>
                                <td>Birth Year</td>
                                <td><?php echo $p["birth_year"] ?></td>
                            </tr>
<?php endif; ?>
<?php if($should_render($p, "is_male")): ?>
                            <tr>
                                <td>Gender</td>
                                <td><?php echo $p["is_male"] ? "Male" : "Female" ?></td>
                            </tr>
<?php elseif($is_profile_owner): ?>
                            <tr>
                                <td>Gender</td>
                                <td class='text-muted'>
                                    Not specified <spall><a href='/profile/edit/step/1'>(Edit)</a></spall>
                                </td>
                            </tr>
<?php endif; ?>
                        </tbody>
                    </table>
                </div>
                <div class='col-md-6 col-sm-12 col-xs-12 about-block' style=''>
                    <legend>Basic Information</legend>
                </div>
            </div>
            <div class='row'>
                <div class='col-md-6 col-sm-12 col-xs-12 about-block' style=''>
                    <legend>Basic Information</legend>
                </div>
                <div class='col-md-6 col-sm-12 col-xs-12 about-block' style=''>
                    <legend>Basic Information</legend>
                </div>
            </div>
        </div>
    </div>
</div>
