<?php if(count($this->messages)) : ?>
    <?php $view = $this; ?>
    <?php 
    $is_me_sending = function(core\db\models\message $message) use($view) {
        return ($message->sender_id == $view->current_user->user_id);
    };
    $get_sender_name = function(core\db\models\message $message) use($view, $is_me_sending) {
        if($is_me_sending($message))
            return $view->current_user->get_RealName_or_Username();
        return $view->target_user->get_RealName_or_Username();
    };
    $get_sender_username = function(core\db\models\message $message) use($view, $is_me_sending) {
        if($is_me_sending($message))
            return $view->current_user->username;
        return $view->target_user->username;
    };
    $get_sender_avatar = function(core\db\models\message $message) use($is_me_sending) {
        $avatar = array();
        if($is_me_sending($message))
            $avatar = core\ui\html\avatar::get_avatar_link($this->current_user->user_id);
        else
            $avatar = core\ui\html\avatar::get_avatar_link($this->target_user->user_id);
        return $avatar[0];
    };
    ?>
<div class="conversations">
    <div class='pull-right conversation-options' style="margin-bottom: 10px;">  
        <div class="btn-group">
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                <span class='glyphicon glyphicon-cog'></span>
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu pull-right">
                <li><a href="#">Delete Messages</a></li>
                <li><a href="#">Mark Conversation</a></li>
                <li class='divider'></li>
                <li><a href="#">Delete Conversation</a></li>
            </ul>
        </div>
    </div>
    <div class="clearfix"></div>
    <?php $this->messages =array_reverse($this->messages); ?>
    <?php $mgroups = array(); ?>
    <?php
        foreach($this->messages as $index => $message): 
            if(!$index || $get_sender_name($this->messages[$index - 1]) != $get_sender_name($message))
                $mgroups[count($mgroups)][] = $message;
            else
                $mgroups[count($mgroups) - 1][] = $message;
        endforeach;
    ?>
    <?php foreach($mgroups as $group): $message = @$group[0];?>
    <div class="message-group">
        <div class="arrow arrow-<?php echo $is_me_sending($message) ? "right me-sending" : "left you-sending" ?>"></div>
        <mgroup class='<?php echo $is_me_sending($message) ? "me-sending" : "you-sending" ?>'>
            <div class='sender-info <?php echo $is_me_sending($message) ? "me-sending" : "you-sending" ?>'>
                <a href='/@<?php echo $get_sender_username($message) ?>'>
                    <img src='<?php echo $get_sender_avatar($message) ?>'  width="50" height="50" class='image img-thumbnail img-responsive' style='margin-right: 3px;'/>
                </a>
            </div>
            <div class="clearfix"></div>
            <div class="separator"></div>
            <?php foreach($group as $message): ?>
                <message>
                    <mhead>
                        <div class='send-date pull-right'>
                            <?php echo $message->created_at; ?>
                        </div>
                    </mhead>
                    <mbody  class="pull-left text-justify" style="word-break: break-all">
                        <?php echo $message->message_data; ?>
                    </mbody>
                </message>
                <div class="clearfix"></div>
            <?php endforeach; ?>
        </mgroup>
        <div class="clearfix"></div>
    </div>
    <?php endforeach; ?>
    <style type='text/css'>
        mgroup{
            display: block;
            width: 80%;
            border: 1px solid #DDD;
            padding: 10px;
            margin-bottom: 10px;
        }
        mgroup .separator{border-bottom: 2px solid #ccc;margin: 10px;padding:0;display: block;}
        message{
            display: block;
            margin: 10px 0 10px 0; 
        }
        message mbody {
            display: block;
            margin-top: 10px;
        }
        message.send-date{}
        message mhead{display: inline; color: #AAA;font-size: small}
        .conversations{margin-right: 10px}
        .media > .me-sending,
        .media > .you-sending {
            margin-right: 10px;
        }
        .arrow-left {
            border-color: transparent #DDD;
            border-style: solid;
            border-width: 10px 10px 10px 0px;
            height: 0px;
            width: 0px;
        }

        .arrow-right {
            border-color: transparent #DDD;
            border-style: solid;
            border-width: 10px 0px 10px 10px;
            height: 0px;
            width: 0px;
        }

        .message-group.arrow-right{
            border-left: 0px;
        }
        .me-sending{
            float: right!important;
        }
        mgroup.me-sending{
            /*background-color: #ccddee;*/
        }
        .you-sending{
            float: left!important;
        }
    </style>
    <script src="/access/js/moment.min.js"></script>
    <script type='text/javascript'>
        $(document).ready(function(){
            $(".send-date").each(function(){
                $(this).html(
                    moment($(this).html(), 'ddd, DD MMM YYYY HH:mm:ss ZZ').format("lll")
                );
            });
            $(".conversation-options a").click(function(){
                alert("!!NO IMPLEMENTED!!");
            });
        });
    </script>
</div>
<?php else: ?>
    <div class="list-group-item">
        <div class="list-group-item-heading text-center" style="font-variant: small-caps;font-weight: bolder">
            <span class='glyphicon glyphicon-warning-sign'></span> No Conversation Found!<br />
            <small class="text-muted" style='font-size: small'>You can only start a conversation directly from users' profile page.</small>
        </div>
    </div>
<?php endif; ?>