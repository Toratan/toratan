<?php if(count($this->messages)) : ?>
    <?php $view = $this; ?>
    <?php 
    $is_me_sending = function(core\db\models\message $message) use($view) {
        return ($message->sender_id == $view->current_user->user_id);
    };
    $get_sender_name = function(core\db\models\message $message) use($view, $is_me_sending) {
        if($is_me_sending($message))
            return $view->current_user->get_RealName_or_Username();
        return $view->target_user->get_RealName_or_Username();
    };
    $get_sender_username = function(core\db\models\message $message) use($view, $is_me_sending) {
        if($is_me_sending($message))
            return $view->current_user->username;
        return $view->target_user->username;
    };
    $get_sender_link = function(core\db\models\message $message) use($get_sender_name, $get_sender_username) {
?>
        <a href='/@<?php echo $get_sender_username($message) ?>'><strong><?php echo $get_sender_name($message); ?></strong></a>
<?php
    };
    $get_sender_avatar = function(core\db\models\message $message) use($is_me_sending) {
        $avatar = array();
        if($is_me_sending($message))
            $avatar = core\ui\html\avatar::get_avatar_link($this->current_user->user_id);
        else
            $avatar = core\ui\html\avatar::get_avatar_link($this->target_user->user_id);
        return $avatar[0];
    };
    ?>
<div class="conversations">
    <div class="topbar">
        <div class="pull-left">
            <a class="btn btn-default" href="<?php echo "#!/send/message/to/{$this->target_user->username}?".\zinux\kernel\security\security::__get_uri_hash_string(array($this->target_user->user_id), @$_SERVER["HTTP_REFERER"])?>" id="send-message">
                <span class="glyphicon glyphicon-retweet"></span> Reply
            </a>
        </div>
        <div class='pull-right conversation-options' style="margin-bottom: 10px;">
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <span class='glyphicon glyphicon-cog'></span>
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu pull-right">
                    <li><a href="#" id="delete-messages-view" onclick="$('.message-check').fadeToggle();">Delete Messages</a></li>
                    <li><a href="#">Mark Conversation</a></li>
                    <li class='divider'></li>
                    <li><a href="#">Delete Conversation</a></li>
                </ul>
            </div>
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="topbar message-check" style="padding-bottom: 10px;">
        <label class="pull-left" style="margin-top: 10px">Select messages to delete</label>
        <div class="pull-right">
            <button class="btn btn-default" onclick='$("a#delete-messages-view").click();'>Cancel</button>
            <button class="btn btn-primary" id="delete-messages-action">Delete</button>
        </div>
    </div>
    <?php $this->messages =array_reverse($this->messages); ?>
    <?php $mgroups = array(); ?>
    <?php
        foreach($this->messages as $index => $message): 
            if(!$index || $get_sender_name($this->messages[$index - 1]) != $get_sender_name($message))
                $mgroups[count($mgroups)][] = $message;
            else
                $mgroups[count($mgroups) - 1][] = $message;
        endforeach;
    ?>
    <div id="topbar-sep"></div>
    <?php foreach($mgroups as $group): $message = @$group[0];?>
    <div class="message-group">
        <div class="arrow arrow-<?php echo $is_me_sending($message) ? "right me-sending" : "left you-sending" ?>"></div>
        <mgroup class='<?php echo $is_me_sending($message) ? "me-sending" : "you-sending" ?>'>
            <div class='sender-info <?php echo $is_me_sending($message) ? "me-sending" : "you-sending" ?>'>
                <?php if($is_me_sending($message)) echo $get_sender_link($message); ?>
                <img src='<?php echo $get_sender_avatar($message) ?>'  width="50" height="50" class='image img-thumbnail img-responsive' style='margin-right: 3px;margin-left: 3px'/>
                <?php if(!$is_me_sending($message)) echo $get_sender_link($message); ?>
            </div>
            <div class="clearfix"></div>
            <div class="separator"></div>
            <?php foreach($group as $message): ?>
                <message id='message-<?php echo $message->message_id ?>'>
                    <mcontainer>
                        <mhead>
                            <div class='send-date pull-right'>
                                <?php echo $message->created_at; ?>
                            </div>
                        </mhead>
                        <mbody  class="pull-left text-justify" style="word-break: break-all">
                            <input type="checkbox" class="message-check input" mid='<?php echo $message->message_id ?>'/>
                            <p><?php echo $message->message_data; ?></p>
                        </mbody>
                        <div class="clearfix"></div>
                    </mcontainer>
                </message>
            <?php endforeach; ?>
        </mgroup>
        <div class="clearfix"></div>
    </div>
    <?php endforeach; ?>
    <style type='text/css'>
        .conversations .topbar{position: absolute;z-index: 1000;background-color: #FFF;border-bottom: 1px solid #e6e6e6;width: 92%}
        .conversations #topbar-sep {padding-top: 55px;}
        .message-check{display: none}
        mgroup{
            display: block;
            width: 68%;
            border: 1px solid #DDD;
            padding: 5px;
            margin-bottom: 10px;
        }
        mgroup .separator{border-bottom: 1px solid #ccc;margin: 10px;padding:0;display: block;}
        message{
            display: block;
            margin: 0px 10px 5px 10px; 
            padding: 15px;
            padding-top: 5px;
        }
        message mbody {
            display: block;
            margin-top: 10px;
            font-size: small
        }
        message.send-date{}
        message mhead{display: inline; color: #AAA;font-size: smaller}
        .conversations{margin-right: 10px;width: 100%}
        .media > .me-sending,
        .media > .you-sending {
            margin-right: 10px;
        }
        .arrow-left {
            border-color: transparent #DDD;
            border-style: solid;
            border-width: 10px 10px 10px 0px;
            height: 0px;
            width: 0px;
        }
        .arrow-right {
            border-color: transparent #DDD;
            border-style: solid;
            border-width: 10px 0px 10px 10px;
            height: 0px;
            width: 0px;
        }
        .message-group.arrow-right{
            border-left: 0px;
        }
        .me-sending{
            float: right!important;
        }
        .you-sending{
            float: left!important;
        }
        @media screen and (min-width:0) and (max-width: 400px) {  
            .topbar{width: 90%!important;}
            .topbar label{font-size: smaller}
            .topbar button{font-size: smaller}
        }
        @media screen and (min-width:410px) and (max-width: 500px) {
            .topbar{width: 88%!important}
        }
        @media screen and (min-width:0) and (max-width: 900px) {
            mgroup {width: 95%!important}
        }
    </style>
    <script src="/access/js/moment.min.js"></script>
    <script type='text/javascript'>
        $(document).ready(function(){
            $(".send-date").each(function(){
                $(this).html(
                    moment($(this).html(), 'ddd, DD MMM YYYY HH:mm:ss ZZ').format("lll")
                );
            });
            $(".conversation-options a").click(function(){
                console.error("!!NO IMPLEMENTED!!");
            });
            $("a#send-message").click(function(e){
                e.preventDefault();
                var href = String($(this).attr('href')).split('#!')[1];
                if(typeof(href) === "undefined") return false;
                $.ajax({
                    type: "GET",
                    url: href+"&suppress_layout=1&ajax=1&inbox=1",
                    success:function(data) {
                        window.open_dialogModal(data);
                    }
                });
            });
            $.propHooks.checked = {
                set: function(elem, value, name) {
                  var ret = (elem[ name ] = value);
                  $(elem).trigger("change");
                  return ret;
                }
            };
            $(".message-check").change(function(){
                if($(this).prop("checked"))
                    $(this).parents("message").css({"background-color": "#F1F2F7", "border": "1px solid #CCC"});
                else
                    $(this).parents("message").css({"background-color": "transparent", "border": "0"});
            });
            $("#delete-messages-action").click(function(){
                window.open_yesnoModal("Once you delete your copy of selected message(s), it cannot be undone.<br />Are you sure?", function(){
                    $(".message-check:checked").each(function(){
                        var $msg = $("message#message-"+$(this).attr('mid'));
                        $msg.addClass("deleted");
                        var $msgp = $msg.parent();
                        if($msgp.children("message:not(.deleted)").length < 1)
                            $msgp.parent(".message-group").slideUp('fast', function(){ $(this).remove(); });
                        else
                            $msg.fadeOut('slow', function(){ $(this).remove(); });
                    });
                });
            });
            $(document).ajaxStart(function(){ window.open_waitModal(); });
            $(document).ajaxStop(function(){ window.open_waitModal(true); });
        });
    </script>
</div>
<?php else: ?>
    <div class="list-group-item">
        <div class="list-group-item-heading text-center" style="font-variant: small-caps;font-weight: bolder">
            <span class='glyphicon glyphicon-warning-sign'></span> No Conversation Found!<br />
            <small class="text-muted" style='font-size: small'>You can only start a conversation directly from users' profile page.</small>
        </div>
    </div>
<?php endif; ?>