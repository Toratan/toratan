<?php if(!@$this->view->profile) throw new \zinux\kernel\exceptions\invalidArgumentException("Not profile instance provided...."); ?>
<?php $is_profile_owner = @$this->view->is_owner;  ?>
<?php $is_preview_mode = @$this->view->preview_mode;  ?>
<?php $active_type = strtolower(@$this->view->active_type);
    switch($active_type) {
        case "about": case "posts": break;
        default: $active_type = "about";
    }
?>
<?php $cover_img =\core\db\models\profile::getInstance($this->view->profile->user_id)->getSetting("/profile/cover/image"); ?>
<?php $glayout = new \modules\defaultModule\views\layout\genLayoutHeader($this); ?>
<?php $glayout->render_header(); ?>
<style type="text/css">
    #cover-photo .cover-img{
        max-height: 410px;
        width: 100%;
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
        border-bottom: 0;
    }
    .navbar-static-top{border-left: 1px solid #DDDDDD; border-right: 1px solid #DDDDDD; margin-top:-10px;}
</style>
<link rel="stylesheet" href="/access/css/mosaic.css" type="text/css" media="screen">
<style type="text/css">
    .icenter-block { float: none; display: -moz-inline-stack; display:inline-block; vertical-align:top; *display:inline; background-color:transparent; }
    .cover-ajax-wait {background-color: yellowgreen;width: 0;}
</style>
<div class="container" style='padding: 0'>
    <div id="cover-photo">
        <div class='mosaic-block bottom-bar icenter-block'>
        <?php if($is_profile_owner) : ?>
            <a class="mosaic-overlay" id="change-cover" style="cursor:pointer;display: inline; left: 0px; bottom: -40px;">
                <div style="height: 3px;" class="cover-ajax-wait"></div>
                <div class="details text-center" style="margin-top: 0;">
                    <h1><span class="glyphicon glyphicon-picture"></span><br /><b>Change Cover</b></h1>
                </div>
            </a>
        <?php endif ; ?>
            <div class="cover-img">
                <img src="<?php echo $cover_img; ?>" class="image imageblock img-responsive img-thumbnail" style=""/>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-default navbar-static-top" role="navigation" >
        <div class="container-fluid">
            <ul class="nav navbar-nav">
                <li class="<?php echo $active_type === "about" ? "active" : "" ?>">
                    <a href="/profile/<?php echo $is_preview_mode?"preview/":""?>about">
                        <span class="glyphicon glyphicon-map-marker"></span> <b>About</b>
                    </a>
                </li>
                <li class="<?php echo $active_type === "posts" ? "active" : "" ?>">
                    <a href="/profile/<?php echo $is_preview_mode?"preview/":""?>posts">
                        <span class="glyphicon glyphicon-book"></span> <b>Posts</b>
                    </a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right" style="margin-right: 0px;">
<?php if(!$is_profile_owner): ?>
                <li title="Send Message">
                    <a href="<?php echo $is_preview_mode?"#": "#message"?>"><span class="glyphicon glyphicon-envelope"></span> Message</a>
                </li>
                <li title="Follow">
                    <a href="<?php echo $is_preview_mode?"#": "#follow"?>"><span class="glyphicon glyphicon-plus"></span> Follow</a>
                </li>
<?php elseif($active_type === "about"): ?>
                <li title='Edit Profile'>
                    <a href='/profile/edit'><span class='glyphicon glyphicon-pencil'></span> Edit</a>
                </li>
                <li title='View your public profile'>
                    <a href='/profile/preview'><span class='glyphicon glyphicon-eye-open'></span> Preview</a>
                </li>
<?php endif; ?>
<?php if($is_preview_mode): ?>
                <li title='Go back to your profile' class="active">
                    <a href='/profile' target=""><span class='glyphicon glyphicon-eye-close'></span> Exit Preview</a>
                </li>
<?php endif;  ?>
            </ul>
        </div>
    </nav>
    <div class="container">
        <?php echo $this->content?>
    </div>
</div> <!-- /container -->
<form name="cover" class="hidden" action="/profile/cover/?<?php echo \zinux\kernel\security\security::GetHashString(array(session_id())) ?>" method="POST" enctype="multipart/form-data">
    <input type="file" name="upload-cover" accept="image/*"/>
</form>
<script type="text/javascript">
    (function(){
        $("a#change-cover").click(function(e){
            e.preventDefault();
            $("input[name='upload-cover']").click();
            if(typeof(window.is_check_cover_load_in_effect) === "undefined")
                window.is_check_cover_load_in_effect = 0;
            $("input[name='upload-cover']").val('');
            function check_cover_load(){
                window.is_check_cover_load_in_effect = 1;
                if($("input[name='upload-cover']").val().length) {
                    // time to load the selected image
                    // no need for further change-cover click event
                    // which can be bug-prone
                    $("a#change-cover").unbind('click');
                    // NOT any more `check_cover_load` is in effect
                    delete(window.is_check_cover_load_in_effect);
                    // invoke cover-load event
                   $("a#change-cover").trigger('load-cover');
                    // do not proceed to next interval call
                    return;
                }
                setTimeout(check_cover_load, 750);
            };
            if(!window.is_check_cover_load_in_effect)
                setTimeout(check_cover_load, 500);
        }).on("load-cover", function(){
            window.ajax_started = 1;
            function ajax_loader_go() {
                $( ".cover-ajax-wait" ).css({width: 0, "margin-left": 0}).animate({ "width": "+=100%" }, 4000, function(){ setTimeout(ajax_loader_back, 100); });    
            }
             function ajax_loader_back(){
                $( ".cover-ajax-wait" ).css({width: "100%", "margin-left": 0}).
                        animate({ "margin-left": "+=100%" }, 3000, function(){  if(window.ajax_started) setTimeout(ajax_loader_go, 100); else delete window.ajax_started; }); 
            };
            ajax_loader_go();
            $("form[name='cover']").submit();
        });
    })(jQuery);
</script>
<?php $glayout->render_footer(); ?>